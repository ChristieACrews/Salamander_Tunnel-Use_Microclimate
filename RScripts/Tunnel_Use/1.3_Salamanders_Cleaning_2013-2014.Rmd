---
title: "1.3 Salamander Capture Data Cleaning - 2013/2014"
author: "Christie Crews"
date: "`r Sys.Date()`"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "HTML_reports") })
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Version of R used: `r getRversion()`
<br> 

### Project

There but geriatric? A resurvey of salamander road mitigation infrastructure in Waterton Lakes National Park 15 years after installation reveals limited use by a small number of aged salamanders
 
<br> 
<br>

### Overview

<br>

#### **Goal(s):**

This script cleans and prepares the 2013/2014 dataset for merging with mine. This includes changing factor names to match my nomenclature, renaming columns to match mine, and adding a column for nearest tunnel. 

<br>

#### **Details about files and pipeline:** 
<br>

1) File information  

The input file for this script was derived from the file "Salamander_Database.accdb" sent by Matt Adams on May 23, 2024. The data was collected by Matt in 2013 and 2014 for a MSc thesis.

I made data entry correction to the database file, as detailed below. I noticed that several rows had notes that indicated an individual was on the road or was detected during a night survey of the road and fence-tunnel system, but did not indicate the nearest tunnel (i.e. Fence#).

<blockquote style="font-size: 100%;">

*Capture*  

* ID: 332, PIT_ID: 135894, changed Fence# from blank to T1rd, the notes mention this individual was on the path to the warden's office and I know the Park's Canada offices are northeast of Tunnel 1 with a worn path just east of the fence end.

* ID: 277, PIT_ID: 135837, changed Fence# from blank to T1rd, the notes mention this individual was in front of the Warden's office garage.

* ID: 307, PIT_ID: 135869, changed Fence# from blank to VC, the notes say this individual was on the road in front of the visitor's center (the old location was just south of bear's hump parking lot).

* ID: 195, PIT_ID: 135655, changed Fence# from blank to VC, the notes say this individual was on the road in front of the visitor's center.

* ID: 214, PIT_ID: 135674, changed Fence# from blank to T1rd, the notes mention this individual was on the path to the warden's office.

* ID: 179, PIT_ID: 135639, changed Fence# from blank to VC, the notes say this individual was on the road south of the visitor's center.

* ID: 1190, PIT_ID: 0, Date: May 2, 2014, changed Fence# from blank to VC, the notes say this individual was on the road south of the visitor's center.

* ID: 1126, PIT_ID: 517620, changed Fence# from blank to T1rd, the notes mention this individual was in front of the Warden's office garage.

* ID: 1219, PIT_ID: 135580, changed Fence# from blank to VC, the notes say this individual was on the road south of the visitor's center.

*Recapture*  

* ID: 305, PIT_ID: 135867, changed Fence# from blank to VC, the notes say this individual was in the grass by the visitor's center sidewalk.

* ID: 352, PIT_ID: 135914, changed Fence# from blank to VC, the notes say this individual was on the road near the visitor's center.

* ID: 13, PIT_ID: 135932, changed Fence# from blank to VC, the notes say this individual was roadkill in front of the visitor's center.

</blockquote>

<br>

2) File contents 


<blockquote style="font-size: 100%;">


Columns in the input file: 

1) ID: numerical order of PIT tags

2) PIT_ID: Last 6 digits of implanted PIT tag (if applicable)

3) Date: Date of capture

4) Time: Time of capture (24hr time)

5) Location: Unique site ID (categorical)

6) Fence#: ID of the fence section an individual was captured at

7) Trap#: ID of the minnow trap an individual was captured in

8) Direction: Direction of travel (upslope or downslope)

9) Species: Species of capture (if not a long-toed salamander)

10) Sex: The sex and life stage of a captured individual

11) Weight: The mass of an individual

12) SVL: The snout-vent length measured to the posterior end of the vent

13) TL: The total length measured from snout to the end of the tail

14) ToeVial: Whether a tissue sample (toe clip) was obtained 

15) VIEColor: Colour of visible implant elastomer injected into an individual

16) Comments: Any additional notes

</blockquote> 

<br>
<br>

### Setting up the R environment
<br>

#### Working directory: 

```{r, message =FALSE}
# setwd("/Users/fabfa/OneDrive/Documents/0 - Frogs/Natural History Note/NatHisNote_DataAnalysis")
```
  
<br>  

#### Libraries: 

```{r, message=FALSE}
# load libraries
library(tidyr)
library(tidyverse)
library(dplyr)
library(hardhat)
library(janitor)
library(ImportExport)
library(lubridate)
```
  
<br>  



### Data and Analysis 


#### Load and explore the data

1. Load the data: 

```{r}
#import access database
Salamander_2013_2014 <- odbcConnectAccess2007("data_raw/Salamander_Database_corrected.accdb") 
#load the tables "Capture" and "Recapture"
indiv_data_2013_2014 <- sqlFetch(Salamander_2013_2014, "Capture")
recapture_2013_2014 <- sqlFetch(Salamander_2013_2014, "Recapture")


```

2. Combine Matt's tables  
*Matt split initial captures and subsequent captures into separate tables. I want merge these datasets now since I will need locations from all captures for analysis later on. I will then clean the merged data frame rather than repeating the same steps for both. First, I need to add a column to each data frame to identify which observations are recaptures, then combine the data*:

```{r}
#add column in  data frame to identify recaptures
recapture_2013_2014 <- recapture_2013_2014 %>%
  mutate(Recapture = "Yes")
#add column to identify which are not recaptures
indiv_data_2013_2014 <- indiv_data_2013_2014 %>%
  mutate(Recapture = "No") 
#some comments in this data frame say "RECAP", 
#will remove these later when working with individual data

#combine captures and recaptures
all_captures_2013_2014 <- merge(indiv_data_2013_2014, recapture_2013_2014, 
                                all.x = TRUE, all.y = TRUE)
```

3. Get information about the data class for each column: 

```{r}
summary(all_captures_2013_2014)
str(all_captures_2013_2014)
``` 
*We can see that we need to adjust the data classes of several columns to make them easier to work with.*

``` {r}
#extracting just time from the Time column since it is in a datetime format
all_captures_2013_2014$Time <- format(as.POSIXct(all_captures_2013_2014$Time), 
                                      format = "%H:%M")

#make several columns into factors
all_captures_2013_2014 <- all_captures_2013_2014 %>% 
  mutate_at(c('Location', 'Fence#', 'Trap#', 'Sex'), as.factor)

```

```{r}
str(all_captures_2013_2014)
summary(all_captures_2013_2014)
``` 

4. Filter observations  
*Matt assessed a second site (Stable Pond), and has observations from other species. Lets filter those out since I just want to compare LTSA at Linnet Lake. Matt only added species name to the Species column for none-LTSA observations of first captures. For recaptures, he did not have a species column and so added species to the comments*

```{r}
#just salamanders and just linnet
all_captures_2013_2014 <- all_captures_2013_2014 %>% 
  filter(is.na(Species), Location == "LL") %>% #LL for Linnet Lake
  subset(!grepl(pattern = "WESTERN TOAD|TIGER", Comments))
```


5. Remove extra columns  
*In 4 I filtered species and location. I did not measure total length, so the TL column is unnecessary for me. The Toe columns and VIE columns also have no use for my data analysis*
``` {r}
#remove extras columns I don't need
all_captures_2013_2014 <- all_captures_2013_2014 %>% 
  select(-Location, -Species, -ToeClip, -ToeVial, -VIE, -VIEColor, -TL)

#remove anything empty
all_captures_2013_2014 <- all_captures_2013_2014 %>% 
  remove_empty(whic=c("cols")) %>% 
  remove_empty(whic=c("rows"))

```

6. Rename columns and variable to match my nomenclature

``` {r}
#change column names
all_captures_2013_2014 <- all_captures_2013_2014 %>% 
  rename(c(Mass_g = Weight, SVL_mm = SVL, Sex_Stage = Sex, TravelDirection = Direction))

#change sex values in Matt's data to match mine
levels(all_captures_2013_2014$Sex_Stage) #check the order of the levels
levels(all_captures_2013_2014$Sex_Stage) <- c("Adult_Female", "Juvenile", "Adult_Male") #make the appropriate change

levels(all_captures_2013_2014$Sex_Stage) #check the change
```

7. Add nearest tunnel  
*To make combining with my data more seamless for location analysis, I want to add a nearest tunnel column to Matt's data. He noted fence sections with a four character code. The first two characters indicate the closest tunnel. The third character indicates downslope (lake side) or upslope (mountain side), and the fourth character indicates the section of fence north or south of the tunnel, or at the tunnel entrance (E). Finally, VC referrers to the old location of the visitor's center, which was just southwest of what we call the bear's hump parking lot and is closest to Tunnel 4.*

``` {r}
#vectors from factor levels of the Fence# column
tunnel_1 <- c("T1DE", "T1DN", "T1DS", "T1rd", "T1UE", "T1UN", "T1US")
tunnel_2 <- c("T2DE", "T2DN", "T2DS", "T2rd", "T2UE", "T2UN", "T2US")
tunnel_3 <- c("T3DE", "T3DN", "T3DS", "T3rd", "T3UE", "T3UN", "T3US")
tunnel_4 <- c("T4DE", "T4DN", "T4DS", "T4rd", "T4UE", "T4UN", "T4US", "VC")

all_captures_2013_2014 <- all_captures_2013_2014 %>%
  mutate(NearestTunnel = case_when(
    `Fence#` %in% tunnel_1 ~ "1",
    `Fence#` %in% tunnel_2 ~ "2",
    `Fence#` %in% tunnel_3 ~ "3",
    `Fence#` %in% tunnel_4 ~ "4")) 
#defaults to NA if none fit, so all the LL fence captures get NA

```


8. Add OlderRecapture column

```{r}
all_captures_2013_2014$OlderRecapture = "No"
```
 This will make it easier to highlight my older recaptures in my figures

9. Final Check:

```{r}
rbind(head(all_captures_2013_2014), tail(all_captures_2013_2014))
```


<br>

#### Final Output

``` {r}
#create csv for the combined data
write.csv(all_captures_2013_2014, "data/All_Captures_2013-2014.csv", row.names=FALSE)

```



### Conclusions 



The next step is to merge all three cleaned datasets (2024, 2025, and 2013/2014.

<br>
<br> 

### Specific notes for the manuscript/thesis 

I would like to note for my manuscript that several individuals were near the old visitor's center or south of it. Matt does not say how far south but based on his methods he did not walk far past the tunnel system. I captured one individual in a similar location to these captures (what is now the Bear's Hump Parking lot). Suggests there has always been migration south of the tunnel system.


<br>
<br> 

### References 

None

<br>
<br> 
